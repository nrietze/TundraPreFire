---
title: "Pre-fire vegetation"
author: "Nils Rietze"
date: "2025-02-03"
output:
  html_document:
    code_folding: "hide"
    theme: sandstone
    highlight: tango
---

# 1. Motivation
- Tundra wildfires impact the climate by directly releasing large amounts of carbon to the atmosphere and indirectly through changes to the land surface budget and carbon emissions from enhanced permafrost thaw.
- The magnitude of these effects depends on the burn severity of wildfires and will likely increase as fire activity is expected to increase in the Arctic.
- Recent studies have shown the factors that influence fire activity and area on various spatial scales, providing a baseline for projections of future fire activity and burned area.
- However, little is known whether these factors also relate to burn severity and consequently how the pre-fire conditions could affect the burn severity in a rapidly changing Arctic.

# 2. Research question
We therefore asked the following research questions:
- What is the role of pre-fire vegetation dynamics on tundra burn severity?

(
- How does the duration and magnitude of water stress buildup relate to the burn severity in tundra fires?
)

```{r setup, include=FALSE}
library(terra)
library(tidyterra)

library(gt)
library(tidyverse)
library(cowplot)
library(patchwork)
set.seed(10)
```

# 3. Data
```{r, include=FALSE}
# 1. Config, loading and preparing data: ----
HLS_DIR <- "~/data/raster/hls/"
index_name = "NDMI"
TEST_ID <- 14211 # fire ID for part of the large fire scar

UTM_TILE_ID <- "54WXE"
year <- 2020
severity_index <- "dNBR"

dnbr <- rast(
  sprintf("~/data/raster/hls/severity_rasters/%s_%s_%s.tif",
          UTM_TILE_ID, year,severity_index)) * 1000

# Load features (fire perimeters and ROIs)
fire_perimeters <- vect(
  "~/data/feature_layers/fire_atlas/viirs_perimeters_in_cavm_e113.gpkg"
)

selected_fire_perimeter <- fire_perimeters %>% 
  filter(fireid  == TEST_ID) %>%
  project(crs(dnbr))

# Buffer the selected fire perimeter
fire_perimeter_buffered <- buffer(selected_fire_perimeter, 1200)

dnbr_in_perimeter <- dnbr %>% 
  mask(fire_perimeter_buffered, updatevalue = NA) %>% 
  crop(fire_perimeter_buffered)
  
sample_points <- vect("~/data/feature_layers/sample_points_burn_date.gpkg") %>% 
  project(crs(dnbr)) %>% 
  mutate(ObservationID = 1:nrow(.))

# Extract data at random points 
dnbr_sample <- terra::extract(dnbr, sample_points,
                              ID = FALSE, xy = TRUE) 
```

<center>![Caption: Conceptual figure showing the studied factors relating to burn severity.](figures/conceptual_figure_sketch.JPG)</center>

## Burn severity (Dependent variable)
Here, burn severity approximates the amount of consumed biomass and depth of organic layer burned in a wildfire. We estimate it with the following indices:
  - Difference Normalized Burn Ration (dNBR): the most commonly used bi-temporal index.
  - Relativized dNBR (RdNBR): Standardized dNBR to make different fires more comparable
  - Difference in the Global Environmental Monitoring Index (dGEMI): was shown to perform equally well as dNBR in tundra fire scars using high-resolution VNIR imagery.
  - Relativized burn ratio (RBR): is more sensitive to picking up high-severity burning.
  
For this briefing, I focus on the dNBR. 

## Pre-fire conditions (independent variables)
### NDMI
I approximate the fuel conditions (fuel dryness) with the normalized difference moisture index (NDMI). 

### NDVI
Approximates the combustible aboveground biomass. I still need to clarify if it is more indicative of the drought conditions (greening dynamics under heatwave conditions) rather than the combustible biomass.

### LST
Indicates land surface cooling as a proxy for the drought conditions. 

- If coupled with NDVI, we could infer a water stress index to really assign this variable to the pre-fire water stress. 
  - This would be something I would consider implementing with people from JPL.

### Topography
Elevation, slope, and aspect may modulate the progression of vegetation conditions before fires, potentially acting as an interaction term on the other variables.

### Day of snow melt
Could influence the trajectory of pre-fire greening trends and pre-fire vegetation canopy moisture availability.

## Fire events: Locaiton and timing of fires
Fire events are the final perimeters defined by the Arctic fire atlas (Scholten et al. 2024). Some fire scars can contain several fire events, e.g., the final fire scar was created by non-consecutive burning (some time in-between new fire activity).

This dataset contains also sub-daily fire perimeters between 2013 - 2023 (VIIRS hotspots) which was used to retrieve the date-of-burning for each sampled point.

# 4. Methods
The test fire event shown below is a part of the large fire scar close to Kytalyk form 2020. This part of the fire scar burned between mid-June to early July. The dNBR is heterogeneous and higher dNBR values indicating higher burn severity are found predominantly in Tussock-Sedge tundra.
```{r}
binwidth = 20
p1 <- ggplot() +
  geom_spatraster(data = dnbr_in_perimeter) +
  scale_fill_viridis_c(option = "inferno",
                       na.value = "white",
                       name = "dNBR") +
  theme_cowplot()

p2 <- ggplot(data = dnbr_in_perimeter, aes(x = dNBR)) +
  geom_histogram(binwidth = binwidth, color = "black", fill = "indianred1") +
  xlim(c(-500,1000)) +
  labs(
    title = "Histogram of dNBR",
    x = "dNBR Values",
    y = "Frequency"
  ) +
  theme_cowplot()

pg <- p1 + p2
```
I then created a random point sample to extract time-series of the vegetation indices (and later LST). 


---
title: "Pre-fire vegetation"
author: "Nils Rietze"
date: "2025-02-03"
output:
  html_document:
    code_folding: "hide"
    theme: sandstone
    highlight: tango
---

# 1. Motivation
- Tundra wildfires impact the climate by directly releasing large amounts of carbon to the atmosphere and indirectly through changes to the land surface budget and carbon emissions from enhanced permafrost thaw.
- The magnitude of these effects depends on the burn severity of wildfires and will likely increase as fire activity is expected to increase in the Arctic.
- Recent studies have shown the factors that influence fire activity and area on various spatial scales, providing a baseline for projections of future fire activity and burned area.
- However, little is known whether these factors also relate to burn severity and consequently how the pre-fire conditions could affect the burn severity in a rapidly changing Arctic.

# 2. Research question
We therefore asked the following research questions:
- What is the role of pre-fire vegetation dynamics on tundra burn severity?
- (How does the duration and magnitude of water stress buildup relate to the burn severity in tundra fires?)

```{r setup, include=FALSE}
library(terra)
library(tidyterra)

library(gt)
library(tidyverse)
library(cowplot)
library(patchwork)
set.seed(10)
```

# 3. Data
```{r, include=FALSE}
# 1. Config, loading and preparing data: ----
HLS_DIR <- "~/data/raster/hls/"
index_name = "NDMI"
TEST_ID <- 14211 # fire ID for part of the large fire scar

UTM_TILE_ID <- "54WXE"
year <- 2020
severity_index <- "dNBR"

dnbr <- rast(
  sprintf("~/data/raster/hls/severity_rasters/%s_%s_%s.tif",
          UTM_TILE_ID, year,severity_index)) * 1000

# Load features (fire perimeters and ROIs)
fire_perimeters <- vect(
  "~/data/feature_layers/fire_atlas/viirs_perimeters_in_cavm_e113.gpkg"
)

selected_fire_perimeter <- fire_perimeters %>% 
  filter(fireid  == TEST_ID) %>%
  project(crs(dnbr))

# Buffer the selected fire perimeter
fire_perimeter_buffered <- buffer(selected_fire_perimeter, 1200)

dnbr_in_perimeter <- dnbr %>% 
  mask(fire_perimeter_buffered, updatevalue = NA) %>% 
  crop(fire_perimeter_buffered)
  
sample_points <- vect("~/data/feature_layers/sample_points_burn_date.gpkg") %>% 
  project(crs(dnbr)) %>% 
  mutate(ObservationID = 1:nrow(.))

# Extract data at random points 
dnbr_sample <- terra::extract(dnbr, sample_points,
                              ID = FALSE, xy = TRUE) 

filename <- sprintf("%s_sampled_%s_%s.csv","merged",UTM_TILE_ID,year)
df_hls <- read.csv2(paste0(HLS_DIR,filename)) %>% 
   mutate(date = as.Date(Time))

# Compute daily means
df_daily_spectral_index <- df_hls %>% 
  group_by(date, ObservationID) %>% 
  summarise(DailyMeanNDMI = mean(NDMI, na.rm = TRUE),
            DailyMeanNDVI = mean(NDVI, na.rm = TRUE),
            dNBR = first(dNBR),
            burn_date = first(burn_date))

# get nr. of valid observations
valid_counts_by_id <- df_daily_spectral_index %>%
  group_by(ObservationID) %>%
  summarise(valid_count = sum(!is.na(DailyMeanNDMI)))
```

<center>![Caption: Conceptual figure showing the studied factors relating to burn severity.](figures/conceptual_figure_sketch.JPG)</center>

## Burn severity (Dependent variable)
Here, burn severity approximates the amount of consumed biomass and depth of organic layer burned in a wildfire. We estimate it with the following indices:
  - Difference Normalized Burn Ration (dNBR): the most commonly used bi-temporal index.
  - Relativized dNBR (RdNBR): Standardized dNBR to make different fires more comparable
  - Difference in the Global Environmental Monitoring Index (dGEMI): was shown to perform equally well as dNBR in tundra fire scars using high-resolution VNIR imagery.
  - Relativized burn ratio (RBR): is more sensitive to picking up high-severity burning.
  
For this briefing, I focus on the dNBR. 

## Pre-fire conditions (independent variables)
### NDMI
I approximate the fuel conditions (fuel dryness) with the normalized difference moisture index (NDMI). 

### NDVI
Approximates the combustible aboveground biomass. I still need to clarify if it is more indicative of the drought conditions (greening dynamics under heatwave conditions) rather than the combustible biomass.

### LST
Indicates land surface cooling as a proxy for the drought conditions. 

- If coupled with NDVI, we could infer a water stress index to really assign this variable to the pre-fire water stress. 
  - This would be something I would consider implementing with people from JPL.

### Topography
Elevation, slope, and aspect may modulate the progression of vegetation conditions before fires, potentially acting as an interaction term on the other variables.

### Day of snow melt
Could influence the trajectory of pre-fire greening trends and pre-fire vegetation canopy moisture availability.

## Fire events: Locaiton and timing of fires
Fire events are the final perimeters defined by the Arctic fire atlas (Scholten et al. 2024). Some fire scars can contain several fire events, e.g., the final fire scar was created by non-consecutive burning (some time in-between new fire activity).

This dataset contains also sub-daily fire perimeters between 2013 - 2023 (VIIRS hotspots) which was used to retrieve the date-of-burning for each sampled point.

# 4. Methods
The test fire event shown below is a part of the large fire scar close to Kytalyk form 2020. This part of the fire scar burned between mid-June to early July. The dNBR is heterogeneous and higher dNBR values indicating higher burn severity are found predominantly in Tussock-Sedge tundra.

## Subsetting 1: Select points with > X observations
```{r}
SAVE_FIGURES <- FALSE

pct_cutoff <- 0.75
thr_nobs <- quantile(valid_counts_by_id$valid_count,pct_cutoff , na.rm = TRUE)

ggplot(valid_counts_by_id) +
  geom_histogram(aes(x = valid_count)) +
  geom_vline(aes(xintercept = thr_nobs),
             color = "red", linetype = "dashed", size = 1) + 
  geom_text(aes(x = thr_nobs-10, y = 300), 
                label = sprintf("%sth percentile = %s",
                                pct_cutoff*100, round(thr_nobs, 2)),
            color = "red", vjust = -1) +
  labs(title = "Number of non-NA observations",
       subtitle = sprintf("Thresholds of valid data (%sth percentile)",
                          pct_cutoff*100)) +
  theme_cowplot()

if (SAVE_FIGURES){
  ggsave2(sprintf("figures/Histogram_%s_observations_%sth_pctile.png",
                index_name,pct_cutoff*100),
        bg = "white",width = 10, height = 8)
}

```

How many observations do the random points have in general?

```{r}
# Plot where number of observations per points
sample_points_filtered <- sample_points %>% 
  merge(valid_counts_by_id, by = "ObservationID")

(p <- ggplot() +
    # geom_spatraster(data = dnbr_in_perimeter, aes(fill = dNBR)) +
    geom_spatvector(data = sample_points_filtered, aes(color = valid_count)) +
    scale_color_viridis_c(option = "magma",
                         na.value = "transparent") +
    labs(fill = "Number of non-masked observations") +
    theme_cowplot()
)

if (SAVE_FIGURES){
  ggsave2(p, 
          filename = "figures/Nobs_randompoints_map.png",
          bg = "white",width = 10, height = 8)
}
```
Where are these points that have more than 80 daily observations?

```{r}
# Load filtered and formatted dataframe
# df_filtered <- read.csv2(sprintf("data/tables/%s_filtered_%sth_pctile.csv",
#                                 index_name,pct_cutoff*100)) %>% 
#   mutate(Time = as.Date(Time),
#          burn_date = as.Date(burn_date))

# Filter out observations with fewer than X observations
df_filtered <- df_daily_spectral_index %>%
  inner_join(valid_counts_by_id, by = "ObservationID") %>%
  filter(valid_count >= thr_nobs,
         year(date) == 2020) %>% 
  select(-valid_count) %>% 
  # Flag pre- & post-fire observations
  mutate(
    burn_date = ymd_hms(burn_date),
    BeforeBurnDate = date < burn_date
  )

# Plot where these filtered points sit
sample_points_filtered <- sample_points %>% 
  filter(ObservationID %in% df_filtered$ObservationID)

(p <- ggplot() +
  geom_spatraster(data = dnbr_in_perimeter, aes(fill = dNBR)) +
  geom_spatvector(data = sample_points_filtered) +
  scale_fill_viridis_c(option = "magma",
                       na.value = "transparent") +
  labs(fill = "dNBR") +
  theme_cowplot()
)
if (SAVE_FIGURES){
  ggsave2(p, 
          filename = sprintf("figures/Location_randompoints_%sth_pctile.png",pct_cutoff*100),
          bg = "white",width = 10, height = 8)
}
```
Is the dNBR distribution for this subset 2 still similar to the original dNBR distribution?
```{r}
p1 <- ggplot(data = dnbr_in_perimeter, aes(x = dNBR)) +
  geom_histogram(binwidth = binwidth, color = "black", fill = "indianred1") +
  xlim(c(-500,1000)) +
  labs(
    title = "Histogram of dNBR in fire perimeter",
    x = "dNBR Values",
    y = "Frequency"
  ) +
  theme_cowplot()

p2 <- df_filtered %>% 
  group_by(ObservationID) %>% 
  summarise(dNBR = first(dNBR)) %>%
  ggplot(data = ., aes(x = dNBR)) +
  geom_histogram(binwidth = binwidth, color = "black", fill = "indianred1") +
  xlim(c(-500,1000)) +
  labs(
    title = "Histogram of dNBR in subset",
    x = "dNBR Values",
    y = "Frequency"
  ) +
  theme_cowplot()

(pg <- p1 + p2)
```
The sampled subset cutting off points with fewer than 80 observations seems to resemble the overall dNBR distribution but cuts off high-severity values. So probably, the cutoff is too conservative.

The question now is a trade-off of capturing the distribution better or avoiding more spatial autocorrelation.

## Time series of NDMI and NDVI show curves before burn start
```{r}
# Time series for all points
# ggplot(df_filtered) +
#   geom_point(aes(x = Time,y = DailyMeanNDMI),alpha = .2) +
#   labs(y = "Daily mean NDMI\n (per point location)") +
#   theme_cowplot()

if (SAVE_FIGURES){
  ggsave2("figures/Timeseries_NDMI_randompoints.png",
          bg = "white",width = 10, height = 8)
}

# Time series for some random points
rand_id <- sample(unique(df_filtered$ObservationID), 16)

df_filtered %>% 
  filter(ObservationID %in% rand_id) %>% 
  ggplot() +
    geom_point(aes(x = date,y = DailyMeanNDMI, color = BeforeBurnDate),alpha = .2) +
    labs(y = sprintf("Daily mean %s\n (per point location)",index_name)) +
    geom_vline(aes(xintercept = as.Date(burn_date)),
               color = "red", linetype = "dashed") +
    facet_wrap(~ObservationID) +
    theme_cowplot()

if (SAVE_FIGURES){
  ggsave2(sprintf("figures/%s_perpoint.png",index_name),
              bg = "white",width = 9, height = 8)
}
```


```{r}
# Histogram of index values
ggplot(df_filtered) +
  geom_histogram(aes(x = DailyMean)) +
  geom_vline(xintercept = mean(df_filtered$DailyMean,na.rm = T),
             color = "red", linetype = "dashed", size = 1) + 
  geom_text(x = 0.2, y = 1e3, 
                label = paste("Mean = ", 
                              round(mean(df_filtered$DailyMean,na.rm = T), 2)), 
            color = "red", vjust = -1) +
  labs(title = sprintf("Histogram of %s values",index_name)) +
  theme_cowplot()

if (SAVE_FIGURES){
  ggsave2(sprintf("figures/Histogram_%s.png",index_name),
          bg = "white",width = 10, height = 8)
}
```

## Pre-fire 
```{r}
# 7. Run pre-fire linear models ----
df_mod <- df_filtered %>%
  group_by(ObservationID) %>% 
  filter(BeforeBurnDate) %>% 
  do(mod = lm(DailyMean ~ Time, data = .)) %>%
  mutate(Slope = summary(mod)$coeff[2],
         Intercept = summary(mod)$coeff[1]) %>%
  select(-mod)

df_mod <- df_filtered %>%
  group_by(ObservationID) %>%
  select(dNBR) %>% 
  summarize(dNBR = first(dNBR)) %>% 
  select(-ObservationID) %>% 
  cbind(df_mod)
    
# Plot slope of index vs. dNBR
ggplot(df_mod) +
  geom_point(aes(x = Slope,y = dNBR),alpha = .2) +
  labs(x = sprintf("Slope of pre-fire %s",index_name),
       y = "dNBR") +
  theme_cowplot()

if (SAVE_FIGURES){
  ggsave2(sprintf("figures/%s_vs_dNBR.png",index_name),
          bg = "white",width = 10, height = 8)
}

sample_points_merged <- sample_points %>% 
  filter(ObservationID %in% df_mod$ObservationID) %>% 
  merge(., df_mod, by = "ObservationID") 

(p <- ggplot() +
    geom_spatraster(data = dnbr_in_perimeter,aes(fill = dNBR)) +
    geom_spatvector(data = sample_points_merged, aes(color = Slope)) +
    scale_fill_viridis_c(option = "magma",
                         na.value = "transparent") +
    scale_color_viridis_c(option = "viridis",
                         na.value = "transparent") +
    labs(fill = "dNBR",
         color = sprintf("Slope %s vs. dNBR",index_name)) +
    theme_cowplot()
)
if (SAVE_FIGURES){
  ggsave2(p, 
          filename = sprintf("figures/Map_Slope_per_Point_%s_vs_dNBR_%sth.png",
                             pct_cutoff*100,index_name),
          bg = "white",width = 10, height = 8)
}

# Report summary stats for pre-fire observations
df_filtered %>%
  group_by(ObservationID) %>%
  filter(BeforeBurnDate) %>%
  summarise(
    n_observations = n()
  ) %>%
  summarise(
    mean_obs = mean(n_observations),
    median_obs = median(n_observations),
    min_obs = min(n_observations),
    max_obs = max(n_observations)
  )

```
I then created a random point sample to extract time-series of the vegetation indices (and later LST). 
```{r}
pct_cutoff <- 0.5

# Load filtered and formatted dataframe
df_filtered <- read.csv2(sprintf("../../data/tables/%s_filtered_%sth_pctile.csv",
                                index_name,pct_cutoff*100)) %>% 
  mutate(Time = as.Date(Time),
         burn_date = as.Date(burn_date))

# Plot where these filtered points sit
sample_points_filtered <- sample_points %>% 
  filter(ObservationID %in% df_filtered$ObservationID)

(p <- ggplot() +
  geom_spatraster(data = dnbr_in_perimeter, aes(fill = dNBR)) +
  geom_spatvector(data = sample_points_filtered) +
  scale_fill_viridis_c(option = "magma",
                       na.value = "transparent") +
  labs(fill = "dNBR") +
  theme_cowplot()
)
```

